import pytesseract
from PIL import Image, ImageEnhance, ImageFilter
import pandas as pd
import os
import re

# Specify the base directory containing the resized_trays folder
base_directory = '/home/epostema/drawers/resized_trays'

# List to hold extracted data
data = []

# Function to extract label information
def extract_label_info(image_path):
    # Open the image file
    img = Image.open(image_path)
    
    # Crop the image to the top 200px
    cropped_img = img.crop((0, 0, img.width, 200))
    
    # Use pytesseract to do OCR on the cropped image
    full_trans = pytesseract.image_to_string(cropped_img)
    
    # Extract information using string operations
    lines = full_trans.split('\n')
    full_taxon = lines[0].strip()
    
    # Extract genus and species
    split_taxon = full_taxon.split()
    genus_species = ' '.join(split_taxon[:2])
    
    geo_code = ''
    year = ''
    
    for part in split_taxon:
        if part.isupper() and len(part) == 3:
            geo_code = part
        elif re.match(r'\d{4}', part):
            year = part
    
    # Allow for different formats of year
    for line in lines:
        if ',' in line:
            coll_year = line.split(',')
            year = coll_year[1].strip().replace(')', '')
        elif '(' in line and ')' in line:
            coll_year = line.split('(')
            year = coll_year[1].strip().replace(')', '')
    
    year_match = re.search(r'\d{4}', full_trans)
    if year_match:
        year = year_match.group(0)
    else:
        year = ''
    
    return {
        'image_file': os.path.basename(image_path),
        'extension': os.path.basename(image_path).replace('_1000.jpg', ''),
        'full_trans': full_trans,
        'full_taxon': genus_species,
        'year': year,
        'geo_code': geo_code
    }

# Function to preprocess image
def preprocess_image(image):
    # Convert to grayscale
    grayscale = image.convert('L')
    # Increase contrast
    enhancer = ImageEnhance.Contrast(grayscale)
    enhanced_image = enhancer.enhance(2)
    # Apply sharpening
    sharpened_image = enhanced_image.filter(ImageFilter.SHARPEN)
    # Apply binarization
    binary_image = sharpened_image.point(lambda x: 0 if x < 128 else 255, '1')
    return binary_image

# Function to extract ID number from the top left region
def extract_id(image_path):
    # Open the image file
    img = Image.open(image_path)
    
    # Crop the image to the top left region (expanded to ensure ID is captured)
    id_crop_img = img.crop((0, 0, 250, 250))
    
    # Preprocess the cropped image
    preprocessed_img = preprocess_image(id_crop_img)
    
    # Use pytesseract to do OCR on the preprocessed image
    id_code = pytesseract.image_to_string(preprocessed_img, config='--psm 6 -c tessedit_char_whitelist=0123456789').strip()
    
    # Extract the ID code using a regular expression to find a 5-digit number
    match = re.search(r'\d{5}', id_code)
    if match:
        return match.group(0)
    else:
        return ''

# Iterate through all subfolders and files in the resized_trays directory
for root, dirs, files in os.walk(base_directory):
    for file in files:
        if file.endswith('.jpg') and 'checkpoint' not in file:
            image_path = os.path.join(root, file)
            label_info = extract_label_info(image_path)
            label_info['id'] = extract_id(image_path)
            data.append(label_info)

# Convert the data to a pandas DataFrame
df = pd.DataFrame(data)

# Create the label_data directory if it doesn't exist
label_data_directory = os.path.join(base_directory, 'label_data')
os.makedirs(label_data_directory, exist_ok=True)

# Save the data to a CSV file in the label_data directory
csv_path = os.path.join(label_data_directory, 'labels.csv')
df.to_csv(csv_path, index=False)

print(f"Label data saved to {csv_path}")
